<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.10.0" />
<title>constriction.stream.chain API documentation</title>
<meta name="description" content="Experimental entropy coding algorithm for advanced variants of bits-back coding â€¦" />
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css" integrity="sha256-PK9q560IAAa6WVRRh76LtCaI8pjTJ2z11v0miyNNjrs=" crossorigin>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css" integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
<link rel="stylesheet preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/github.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js" integrity="sha256-Uv3H6lx7dJmRfRvH8TH6kJD1TSK1aFcwgx+mdg3epi8=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>constriction.stream.chain</code></h1>
</header>
<section id="section-intro">
<p>Experimental entropy coding algorithm for advanced variants of bits-back coding.</p>
<p>This module provides the <code><a title="constriction.stream.chain.ChainCoder" href="#constriction.stream.chain.ChainCoder">ChainCoder</a></code>, an experimental entropy coder that is similar
to an <a href="stack.html#constriction.stream.stack.AnsCoder"><code>AnsCoder</code></a> in that it operates as
a stack (i.e., a last-in-first-out data structure). However, different to an <code>AnsCoder</code>,
a <code><a title="constriction.stream.chain.ChainCoder" href="#constriction.stream.chain.ChainCoder">ChainCoder</a></code> treats each symbol independently. Thus, when decoding some bit string
into a sequence of symbols, any modification to the entropy model for one symbol does
not affect decoding for any other symbol (by contrast, when decoding with an <code>AnsCoder</code>
or <code>RangeDecoder</code>, a change to the entropy model for one symbol can affect <em>all</em>
subsequently decoded symbols too, see <a href="#motivation">Motivation</a> below).</p>
<p>This property of treating symbols independently upon decoding can be useful for advanced
compression methods that combine inference, quantization, and bits-back coding.</p>
<h2 id="motivation">Motivation</h2>
<p>The following two examples illustrate how decoding differs between an <code>AnsCoder</code> and a
<code><a title="constriction.stream.chain.ChainCoder" href="#constriction.stream.chain.ChainCoder">ChainCoder</a></code>. In the first example, we decode from the same bitstring <code>data</code> twice with
an <code>AnsCoder</code>: a first time with an initial sequence of toy entropy models, and then a
second time with a slightly different sequence of entropy models. Importantly, we change
only the entropy model for the first decoded symbol (and the change is small). The
entropy models for all other symbols remain exactly unmodified. We observe, however,
that changing the first entropy model affects not only the first decoded symbol. It also
has a ripple effect on subsequently decoded symbols.</p>
<pre><code class="language-python"># Some sample binary data and sample probabilities for our entropy models
data = np.array([0x80d14131, 0xdda97c6c, 0x5017a640, 0x01170a3d], np.uint32)
probabilities = np.array(
    [[0.1, 0.7, 0.1, 0.1],  # (&lt;-- probabilities for first decoded symbol)
     [0.2, 0.2, 0.1, 0.5],  # (&lt;-- probabilities for second decoded symbol)
     [0.2, 0.1, 0.4, 0.3]]) # (&lt;-- probabilities for third decoded symbol)
model_family = constriction.stream.model.Categorical()

# Decoding `data` with an `AnsCoder` results in the symbols `[0, 0, 1]`:
ansCoder = constriction.stream.stack.AnsCoder(data, seal=True)
print(ansCoder.decode(model_family, probabilities)) # (prints: [0, 0, 1])

# Even if we change only the first entropy model (slightly), *all* decoded
# symbols can change:
probabilities[0, :] = np.array([0.09, 0.71, 0.1, 0.1])
ansCoder = constriction.stream.stack.AnsCoder(data, seal=True)
print(ansCoder.decode(model_family, probabilities)) # (prints: [1, 0, 3])
</code></pre>
<p>It's no surprise that the first symbol changed since we changed its entropy model. But
note that the third symbol changed too even though we hadn't changed its entropy model.
Thus, in ANS (as in most codes), changes to entropy models have a
<em>global</em> effect.</p>
<p>Now let's try the same with a <code><a title="constriction.stream.chain.ChainCoder" href="#constriction.stream.chain.ChainCoder">ChainCoder</a></code>:</p>
<pre><code class="language-python"># Same compressed data and original entropy models as in our first example
data = np.array([0x80d14131, 0xdda97c6c, 0x5017a640, 0x01170a3d], np.uint32)
probabilities = np.array(
    [[0.1, 0.7, 0.1, 0.1],
     [0.2, 0.2, 0.1, 0.5],
     [0.2, 0.1, 0.4, 0.3]])
model_family = constriction.stream.model.Categorical()

# Decode with the original entropy models, this time using a `ChainCoder`:
chainCoder = constriction.stream.chain.ChainCoder(data, seal=True)
print(chainCoder.decode(model_family, probabilities)) # (prints: [0, 3, 3])

# We obtain different symbols than for the `AnsCoder`, of course, but that's
# not the point here. Now let's change the first model again:
probabilities[0, :] = np.array([0.09, 0.71, 0.1, 0.1])
chainCoder = constriction.stream.chain.ChainCoder(data, seal=True)
print(chainCoder.decode(model_family, probabilities)) # (prints: [1, 3, 3])
</code></pre>
<p>Notice that the only symbol that changed was the one whose entropy model we had changed.
Thus, in a <code><a title="constriction.stream.chain.ChainCoder" href="#constriction.stream.chain.ChainCoder">ChainCoder</a></code>, changes to entropy models (and also to compressed bits) only
have a <em>local</em> effect on the decompressed symbols.</p>
<h2 id="how-does-this-work">How does this work?</h2>
<p>A <code><a title="constriction.stream.chain.ChainCoder" href="#constriction.stream.chain.ChainCoder">ChainCoder</a></code> is a variant on ANS. To understand how a <code><a title="constriction.stream.chain.ChainCoder" href="#constriction.stream.chain.ChainCoder">ChainCoder</a></code> works, one first
has to understand how an <code>AnsCoder</code> works. When an <code>AnsCoder</code> decodes a symbol, it
performs the following three steps:</p>
<ol>
<li>The <code>AnsCoder</code> consumes a fixed amount of bits (24 bits in <code><a title="constriction" href="../index.html">constriction</a></code>'s default
configuration) from the end of its encapsulated compressed data; then</li>
<li>the <code>AnsCoder</code> interprets these 24 bits as a number <code>xi</code> between 0.0 and 1.0 in fixed
point representation, and it maps <code>xi</code> to a symbol using the entropy model's quantile
function (aka percent point function); finally</li>
<li>the <code>AnsCoder</code> uses the bits-back trick to write (24 - inf_content) bits worth of
(amortized) bits back onto the encapsulated compressed data; these "returned" bits
reflect the information contained in the precise position of the number <code>xi</code> within
the whole range of numbers that the quantile function would map to the same symbol.</li>
</ol>
<p>A <code><a title="constriction.stream.chain.ChainCoder" href="#constriction.stream.chain.ChainCoder">ChainCoder</a></code> breaks these three steps apart. It encapsulates <em>two</em> rather than just
one bitstring buffers, referred to in the following as "compressed" and "remainders".
When you call the constructor of <code><a title="constriction.stream.chain.ChainCoder" href="#constriction.stream.chain.ChainCoder">ChainCoder</a></code> with argument <code>is_remainders=False</code> (which
is the default) then the provided argument <code>data</code> is used to initialize the "compressed"
buffer. When the <code><a title="constriction.stream.chain.ChainCoder" href="#constriction.stream.chain.ChainCoder">ChainCoder</a></code> decodes a symbol, it executes steps 1-3 from above, with
the modification that step 1 reads from the "compressed" buffer while step 3 writes to
the "remainders" buffer. Since step 1 is independent of the employed entropy model,
changes to the entropy model have no effect on subsequently decoded symbols.</p>
<p>Once you're done decoding a sequence of symbols, you can concatenate the two buffers to
a single one.</p>
<h2 id="usage-for-bits-back-coding">Usage for Bits-Back Coding</h2>
<p>A typical usage cycle of a <code><a title="constriction.stream.chain.ChainCoder" href="#constriction.stream.chain.ChainCoder">ChainCoder</a></code> goes along the following steps:</p>
<h3 id="when-compressing-data-using-the-bits-back-trick">When compressing data using the bits-back trick</h3>
<ol>
<li>Start with some array of (typically already compressed) binary data, which you want
to piggy-back into the choice of latent variables in a latent variable entropy model.</li>
<li>Create a <code><a title="constriction.stream.chain.ChainCoder" href="#constriction.stream.chain.ChainCoder">ChainCoder</a></code>, passing into the constructor the binary data and the arguments
<code>is_remainders=False</code> and <code>seal=True</code> (you can set <code>seal=False</code> if you know that the
data cannot end in a zero word, e.g., if it comes from
<code>AnsCoder.get_compressed(unseal=False)</code>).</li>
<li>Decode the latent variables from the <code><a title="constriction.stream.chain.ChainCoder" href="#constriction.stream.chain.ChainCoder">ChainCoder</a></code> as usual in bits-back coding.</li>
<li>Export the remaining data on the <code><a title="constriction.stream.chain.ChainCoder" href="#constriction.stream.chain.ChainCoder">ChainCoder</a></code> by calling its method
<code>.get_remainders()</code>. The method returns two numpy arrays, which you may concatenate in
order.</li>
<li>You can now use this remaining binary data in an <code>AnsCoder</code> (it is guaranteed not to
have a zero word at the end, so you can set <code>seal=False</code> in the constructor of
<code>AnsCoder</code>), and you can encode a message on top of it using entropy models that are
conditioned on the latent variables you just decoded.</li>
</ol>
<h3 id="when-decompressing-the-data">When decompressing the data</h3>
<ol>
<li>Recreate the binary data that you had after encoder step 4 above, and the latent
variables that you decoded in encoder step 3 above, as usual in bits-back coding.</li>
<li>Pass it to the constructor of <code><a title="constriction.stream.chain.ChainCoder" href="#constriction.stream.chain.ChainCoder">ChainCoder</a></code>, with additional arguments
<code>is_remainders=True</code> (<code>seal</code> always has to be <code>False</code> when <code>is_remainders=True</code>
because remainders data is guaranteed not to end in a zero word).</li>
<li>Encode the latent variables back onto the new <code><a title="constriction.stream.chain.ChainCoder" href="#constriction.stream.chain.ChainCoder">ChainCoder</a></code> (in reverse order), using
the same entropy models as during decoding.</li>
<li>Recover the original binary data from encoder step 1 above by calling
<code>.get_data(unseal=True)</code> (if you set <code>seal=False</code> in encoder step 2 above, then set
<code>unseal=False</code> now). The method returns two arrays, which you may concatenate in
order.</li>
</ol>
</section>
<section>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-classes">Classes</h2>
<dl>
<dt id="constriction.stream.chain.ChainCoder"><code class="flex name class">
<span>class <span class="ident">ChainCoder</span></span>
<span>(</span><span>self, compressed, is_remainders=False, seal=False)</span>
</code></dt>
<dd>
<div class="desc"><p>See <a href="#usage-for-bits-back-coding">above usage instructions</a> for explanation of
constructor arguments.</p></div>
<h3>Methods</h3>
<dl>
<dt id="constriction.stream.chain.ChainCoder.clone"><code class="name flex">
<span>def <span class="ident">clone</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"><p>Creates a deep copy of the coder and returns it.</p>
<p>The returned copy will initially encapsulate the identical compressed data and
remainders as the original coder, but the two coders can be used independently
without influencing other.</p></div>
</dd>
<dt id="constriction.stream.chain.ChainCoder.decode"><code class="name flex">
<span>def <span class="ident">decode</span></span>(<span>self, model, *optional_amt_or_model_params)</span>
</code></dt>
<dd>
<div class="desc"><p>Decodes one or more symbols.</p>
<p>Usage is analogous to <a href="stack.html#constriction.stream.stack.AnsCoder.decode"><code>AnsCoder.decode</code></a>.</p>
<p>Decoding consumes the fixed amount of 24 bits per encoded symbol from the internal
"compressed" buffer, regardless of the employed entropy model(s), and it appends (24
bits - inf_content) per symbol to the internal "remainders" buffer (where
"inf_content" is the information content of the decoded symbol under the employed
entropy model).</p></div>
</dd>
<dt id="constriction.stream.chain.ChainCoder.encode_reverse"><code class="name flex">
<span>def <span class="ident">encode_reverse</span></span>(<span>self, symbols, model, *optional_model_params)</span>
</code></dt>
<dd>
<div class="desc"><p>Encodes one or more symbols.</p>
<p>Usage is analogous to <a href="stack.html#constriction.stream.stack.AnsCoder.encode_reverse"><code>AnsCoder.encode_reverse</code></a>.</p>
<p>Encoding appends the fixed amount of 24 bits per encoded symbol to the internal "compressed"
buffer, regardless of the employed entropy model(s), and it consumes (24 bits - inf_content)
per symbol from the internal "remainders" buffer (where "inf_content" is the information
content of the encoded symbol under the employed entropy model).</p></div>
</dd>
<dt id="constriction.stream.chain.ChainCoder.get_data"><code class="name flex">
<span>def <span class="ident">get_data</span></span>(<span>self, unseal=False)</span>
</code></dt>
<dd>
<div class="desc"><p>Returns a copy of the compressed data after re-encoding symbols, split into two
arrays that you may want to concatenate.</p>
<p>See <a href="#usage-for-bits-back-coding">above usage instructions</a> for further explanation.</p></div>
</dd>
<dt id="constriction.stream.chain.ChainCoder.get_remainders"><code class="name flex">
<span>def <span class="ident">get_remainders</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"><p>Returns a copy of the remainders after decoding some symbols, split into two arrays
that you may want to concatenate.</p>
<p>See <a href="#usage-for-bits-back-coding">above usage instructions</a> for further explanation.</p></div>
</dd>
</dl>
</dd>
</dl>
</section>
</article>
<nav id="sidebar">
<h1>Index</h1>
<div class="toc">
<ul>
<li><a href="#motivation">Motivation</a></li>
<li><a href="#how-does-this-work">How does this work?</a></li>
<li><a href="#usage-for-bits-back-coding">Usage for Bits-Back Coding</a><ul>
<li><a href="#when-compressing-data-using-the-bits-back-trick">When compressing data using the bits-back trick</a></li>
<li><a href="#when-decompressing-the-data">When decompressing the data</a></li>
</ul>
</li>
</ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="constriction.stream" href="../stream.html">constriction.stream</a></code></li>
</ul>
</li>
<li><h3><a href="#header-classes">Classes</a></h3>
<ul>
<li>
<h4><code><a title="constriction.stream.chain.ChainCoder" href="#constriction.stream.chain.ChainCoder">ChainCoder</a></code></h4>
<ul class="">
<li><code><a title="constriction.stream.chain.ChainCoder.clone" href="#constriction.stream.chain.ChainCoder.clone">clone</a></code></li>
<li><code><a title="constriction.stream.chain.ChainCoder.decode" href="#constriction.stream.chain.ChainCoder.decode">decode</a></code></li>
<li><code><a title="constriction.stream.chain.ChainCoder.encode_reverse" href="#constriction.stream.chain.ChainCoder.encode_reverse">encode_reverse</a></code></li>
<li><code><a title="constriction.stream.chain.ChainCoder.get_data" href="#constriction.stream.chain.ChainCoder.get_data">get_data</a></code></li>
<li><code><a title="constriction.stream.chain.ChainCoder.get_remainders" href="#constriction.stream.chain.ChainCoder.get_remainders">get_remainders</a></code></li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc" title="pdoc: Python API documentation generator"><cite>pdoc</cite> 0.10.0</a>.</p>
</footer>
</body>
</html>